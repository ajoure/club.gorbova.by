name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    # REMOVED: paths restriction - deploy functions on EVERY push to main
    # This ensures functions are always deployed after publish
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff comparison

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref hdjgkjceownmmnrqqtuz
          
          echo "========================================"
          echo "DEPLOYMENT STRATEGY: Full deterministic deploy"
          echo "========================================"
          
          # Deploy ALL functions that have index.ts (deterministic, not diff-based)
          DEPLOYED_COUNT=0
          FAILED_COUNT=0
          SKIPPED_COUNT=0
          
          for dir in supabase/functions/*/; do
            func_name=$(basename "$dir")
            
            # Skip shared modules (directories starting with _)
            if [[ "$func_name" == _* ]]; then
              echo "⏭️ Skipping shared module: $func_name"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              continue
            fi
            
            if [ -f "$dir/index.ts" ]; then
              echo ""
              echo "--- Deploying: $func_name ---"
              if supabase functions deploy "$func_name"; then
                echo "✅ Deployed: $func_name"
                DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
              else
                echo "❌ FAILED to deploy: $func_name"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                # Continue deploying others, but mark as failed
              fi
            else
              echo "⏭️ Skipping (no index.ts): $func_name"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            fi
          done
          
          echo ""
          echo "========================================"
          echo "DEPLOYMENT SUMMARY"
          echo "========================================"
          echo "✅ Deployed: $DEPLOYED_COUNT"
          echo "❌ Failed: $FAILED_COUNT"
          echo "⏭️ Skipped: $SKIPPED_COUNT"
          echo "========================================"
          
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "::error::$FAILED_COUNT functions failed to deploy!"
            exit 1
          fi
          
          # ============================================
          # SMOKE CHECKS: Verify critical functions are reachable
          # ============================================
          echo ""
          echo "Running smoke checks for critical functions..."
          
          # P0: Must-exist functions (business critical)
          CRITICAL_FUNCTIONS=(
            "payment-method-verify-recurring"
            "bepaid-list-subscriptions"
            "bepaid-get-subscription-details"
            "bepaid-create-token"
            "admin-payments-diagnostics"
            "integration-healthcheck"
            "nightly-system-health"
            "nightly-payments-invariants"
            "public-product"
            "telegram-webhook"
            "users-admin-actions"
          )
          
          SUPABASE_URL="https://hdjgkjceownmmnrqqtuz.supabase.co"
          ORIGIN="https://796a93b9-74cc-403c-8ec5-cafdb2a5beaa.lovableproject.com"
          SMOKE_FAILED=0
          
          for func in "${CRITICAL_FUNCTIONS[@]}"; do
            echo ""
            echo "=== Smoke check: $func ==="
            
            # POST existence check (primary)
            POST_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X POST \
              -H "Content-Type: application/json" \
              -d '{"ping":true}' \
              "$SUPABASE_URL/functions/v1/$func" 2>&1)
            
            POST_STATUS=$(echo "$POST_RESPONSE" | tail -1)
            POST_BODY=$(echo "$POST_RESPONSE" | sed '$d')
            
            if [ "$POST_STATUS" = "404" ]; then
              echo "❌ FAIL: $func returned 404 NOT_FOUND"
              SMOKE_FAILED=1
            elif [ "$POST_STATUS" = "000" ]; then
              echo "❌ FAIL: $func - connection failed"
              SMOKE_FAILED=1
            elif echo "$POST_BODY" | grep -q '"code":"NOT_FOUND"'; then
              echo "❌ FAIL: $func returned NOT_FOUND in body"
              SMOKE_FAILED=1
            else
              echo "✅ OK: $func returned HTTP $POST_STATUS (function exists)"
            fi
          done
          
          echo ""
          echo "========================================"
          
          if [ "$SMOKE_FAILED" = "1" ]; then
            echo "::error::Smoke checks failed! One or more critical functions are not reachable."
            exit 1
          fi
          
          echo "✅ All smoke checks passed!"
          echo ""
          echo "DEPLOYMENT COMPLETE: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
