# План: Исправления мастера KB и система монетизации уроков

## ✅ ВЫПОЛНЕНО

### Фаза 1 — Критические баги
1. ✅ **Исправлен скролл** — заменён `ScrollArea` на нативный `overflow-y-auto` с ограничением высоты
2. ✅ **Исправлен фильтр бота** — изменён с `.eq("status", "ok")` на `.in("status", ["ok", "active"])`
3. ✅ **Перемещён LessonNotificationConfig** на шаг «Урок» (после ввода данных)

### Фаза 2 — ИИ генерация
1. ✅ **Создана edge-функция `generate-lesson-notification`** — использует Lovable AI (gemini-2.5-flash) для генерации текста в стиле Катерины Горбовой
2. ✅ **Подключен ИИ** к кнопке «Сгенерировать» в LessonNotificationConfig
3. ✅ **Добавлены props** `episodeNumber` и `questions` для контекста генерации

### Фаза 3 — Монетизация уроков
1. ✅ **Миграция БД**: добавлен `product_id` в `training_lessons`
2. ✅ **Миграция БД**: создана таблица `lesson_price_rules` с RLS
3. ✅ **Создан компонент `LessonSaleConfig`**:
   - Переключатель «Продавать отдельно»
   - Базовая цена
   - Длительность доступа (навсегда / N дней / до конца периода)
   - Правила цен по тарифам
4. ✅ **Интеграция в мастер** на шаге «Доступ»
5. ✅ **Логика создания продукта** при сохранении:
   - Создание `products_v2` с category='lesson'
   - Создание `tariffs` с access_days
   - Создание `tariff_offers` с ценами
   - Сохранение `lesson_price_rules`
   - Обновление урока с `product_id`

---

## ⏳ В РАБОТЕ / СЛЕДУЮЩИЕ ШАГИ

### Фаза 4 — Улучшение UI покупки (следующий спринт)
- [ ] Добавить кнопку «Купить» в `LessonCard` для уроков с `product_id`
- [ ] Создать хук `useLessonPrice` для расчёта персональной цены
- [ ] Показывать меню покупки для пользователей без доступа
- [ ] Обновить RLS `lesson_blocks` для проверки `product_id` урока

### Фаза 5 — Улучшение обложек
- [ ] Создать bucket `owner-photos` в Storage
- [ ] Обновить `generate-cover` для использования фото Катерины
- [ ] Добавить UI для загрузки референсных фото

---

## Архитектура монетизации

```
┌──────────────────────────────────────────────────────────────────┐
│                      СХЕМА ДАННЫХ                                │
├──────────────────────────────────────────────────────────────────┤
│  training_lessons                                                │
│  ├─ id                                                           │
│  ├─ product_id ───────► products_v2 (category='lesson')         │
│  └─ ...                                                          │
│                                                                  │
│  lesson_price_rules                                              │
│  ├─ lesson_id ───────► training_lessons.id                       │
│  ├─ tariff_id ───────► tariffs.id (для какого тарифа скидка)    │
│  └─ price                                                        │
└──────────────────────────────────────────────────────────────────┘
```

При покупке урока:
1. Проверяем текущие подписки пользователя
2. Находим пересечение с `lesson_price_rules`
3. Берём минимальную цену (или базовую, если нет совпадений)
4. Создаём `entitlement` на `product_code` урока
