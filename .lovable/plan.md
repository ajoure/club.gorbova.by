
Цели (что должно получиться)
1) В “База знаний → Вопросы” кнопка «Смотреть видеоответ» всегда ведёт ВНУТРИ платформы на страницу видеоответа (без новых окон и без перехода на внешний сайт).
2) На странице видеоответа при выборе вопроса (Play) видео:
   - переходит к указанному таймингу,
   - и запускается сразу (без “замерло, нажмите Play ещё раз”).
3) Хлебные крошки:
   - без дублей (одна линия),
   - полностью на русском,
   - без технических slug’ов типа “episode-100”, “container-…”, “Library…”.
4) В карточках выпусков (превью видео/выпусков) краткое описание отображается аккуратно, но полный текст доступен красиво:
   - desktop: по наведению (tooltip/hover-card) или по клику,
   - mobile/tablet: через “Развернуть” (без ховера), удобно пальцем.
5) По итогам — проверка и скрины (доказательства) по ключевым сценариям + быстрый smoke по кнопкам/полям, чтобы ничего не сломалось.

Что уже выяснено по коду (причины текущих проблем)
A) Дубли хлебных крошек
- В шапке DashboardLayout всегда рендерится <DashboardBreadcrumbs />.
- При этом LibraryLesson.tsx и LibraryModule.tsx рендерят свои “внутренние” хлебные крошки прямо в контенте.
⇒ Поэтому на странице урока видны сразу две линии хлебных крошек (как на вашем скрине).

B) “Смотреть видеоответ” уходит на Kinescope (у вас)
- В текущем коде src/pages/Knowledge.tsx кнопка уже сделана как <button> + navigate() (не <a target="_blank">).
- Значит, либо:
  1) на опубликованной версии ещё старый код (не опубликовано/кэш),
  2) либо где-то ещё есть второй список вопросов (другая страница/компонент) с внешней ссылкой,
  3) либо в момент клика не хватает данных lesson/module, и где-то включается fallback на внешнюю ссылку (мы добавим “безопасный” fallback: НЕ открывать внешнее, а показывать понятное сообщение).

C) Автозапуск по таймкоду не срабатывает
- Сейчас мы добавили в embed URL параметр autoplay=1, но браузеры часто блокируют autoplay со звуком.
- Для надёжного запуска нужен “управляемый плеер”: Kinescope IFrame API (seekTo + play) + (при необходимости) mute перед play, чтобы пройти ограничения браузера.

D) На странице урока нет обработки navigate state seekTo
- В текущем src/pages/LibraryLesson.tsx активный таймкод меняется только при клике на Play в списке вопросов на этой странице.
- Но когда пользователь приходит из /knowledge по navigate(..., { state: { seekTo } }), этот seekTo сейчас не считывается (в файле нет useLocation и эффекта).
⇒ В результате переход “на нужный тайминг” может не применяться/применяться нестабильно.

E) Полный текст “краткого описания” в превью
- В LessonCard описание ограничено line-clamp-2 (обрезается).
⇒ Нужно оставить аккуратный вид, но дать доступ к полному тексту через hover/expand, адаптируя под mobile/tablet.

План изменений (точечно, без рефакторинга “ради красоты”)

1) Исправить автозапуск видео по таймкоду (надёжно)
Файлы:
- src/components/admin/lesson-editor/blocks/VideoBlock.tsx
- (при необходимости) src/pages/LibraryLesson.tsx

1.1. Добавить “режим управляемого плеера” для Kinescope в просмотре (isEditing=false)
- Для provider === 'kinescope' вместо “голого iframe src=…” подключить Kinescope IFrame API:
  - загрузка скрипта: https://player.kinescope.io/latest/iframe.player.js (один раз, с кэшированием promise),
  - создание плеера через playerFactory.create(...) в контейнере,
  - хранение instance в ref,
  - при изменении activeTimecode:
    - await player.seekTo(seconds)
    - (опционально) await player.mute()  (чтобы autoplay не блокировался)
    - await player.play()

Почему так:
- Параметр autoplay=1 в URL может блокироваться политикой браузера.
- Прямой вызов play() через API в ответ на “пользовательское действие” и/или с mute даёт предсказуемый старт.

1.2. Сохранить безопасный fallback
- Если API не загрузилось/ошибка создания — оставить текущий iframe embedUrl (как резервный вариант), чтобы видео всё равно показывалось.

1.3. На странице урока: добавить обработку “пришёл из списка вопросов → сразу seek+play”
Файл:
- src/pages/LibraryLesson.tsx

Сделать:
- подключить useLocation()
- при монтировании/изменении location.state:
  - если state.seekTo — setActiveTimecode(seekTo) + “флаг автозапуска” (например autoplayNonce = Date.now()).
- передать autoplayNonce в LessonBlockRenderer → VideoBlock, чтобы VideoBlock понимал “это запуск по клику/переходу, надо стартовать”.

Также:
- когда пользователь выбирает вопрос на самой странице урока (кнопка Play рядом с вопросом), вместе с setActiveTimecode выставлять autoplayNonce, чтобы запуск был гарантирован.

2) Полностью убрать внешние переходы на Kinescope из “База знаний → Вопросы”
Файл:
- src/pages/Knowledge.tsx

2.1. Жёстко запретить внешний fallback
- Сейчас уже есть navigate(`/library/${moduleSlug}/${lessonSlug}`, { state: { seekTo } }).
- Добавить поведение, если не хватает moduleSlug/lessonSlug:
  - не открывать внешнюю ссылку,
  - показать toast “Видеоответ пока не привязан к уроку” (и лог в console.warn для диагностики данных).

2.2. Диагностика, чтобы поймать причину “почему у вас всё равно открывается Kinescope”
- Временно (пока не подтвердим фикс) добавить console.warn с данными вопроса при отсутствии lesson/module.
- После подтверждения можно убрать (или оставить только минимально).

2.3. Проверить, что в проекте нет других мест, где кнопка “Смотреть видеоответ” реализована через <a target="_blank">
- По поиску сейчас явных совпадений в src нет, но мы дополнительно проверим места использования kinescope_url / buildKinescopeUrlWithTimecode и UI “вопросов” вне Knowledge.tsx.

3) Убрать дубли хлебных крошек и привести всё к русскому
Файлы:
- src/components/layout/DashboardLayout.tsx
- src/components/layout/DashboardBreadcrumbs.tsx
- src/pages/LibraryLesson.tsx
- src/pages/LibraryModule.tsx

3.1. Убрать “вторую линию” хлебных крошек
Вариант, который минимально ломает и даёт правильный русский путь “База знаний → …”:
- Оставляем “внутренние” хлебные крошки в LibraryLesson/LibraryModule (они уже правильно показывают “База знаний → Выпуск №100” через title).
- В DashboardLayout скрываем <DashboardBreadcrumbs /> на маршрутах /library/* (и при необходимости /library) — чтобы в шапке не было второй линии.

Почему так:
- DashboardBreadcrumbs сейчас не умеет красиво переводить slug’и “episode-100” в “Выпуск №100” без отдельной логики (и без лишнего рефакторинга).
- Внутренние крошки в LibraryLesson уже корректные и русские, их проще оставить.

3.2. Русификация заголовков для /knowledge
- В DashboardBreadcrumbs обновить routeLabels для “/knowledge”, чтобы в шапке (на страницах, где шапка-crumb включена) было “База знаний”, а не “Знания”.

3.3. Проверка, что нигде не показывается “episode-100” как текст
- В LibraryLesson уже выводится currentLesson.title (должно быть “Выпуск №100”).
- Если в БД title оказался равен slug’у у каких-то уроков (редкий кейс) — в таком случае потребуется точечная правка импорта/данных (но сначала проверим реальными SELECT и UI).

4) Полный текст краткого описания в превью (красиво, удобно на mobile/tablet)
Файл:
- src/components/training/LessonCard.tsx
(при необходимости) UI-компоненты hover-card / collapsible уже есть.

4.1. Desktop: HoverCard на описании
- Если lesson.description длиннее N символов:
  - оставить line-clamp-2,
  - по наведению показывать HoverCard с полным текстом (ширина адаптивная, max-w, переносы строк).

4.2. Mobile/Tablet: “Показать полностью” внутри карточки
- Так как hover на мобильных не работает:
  - добавить кнопку “Показать полностью / Свернуть” (44px touch target),
  - по клику разворачивать текст прямо в карточке (Collapsible),
  - обязательно stopPropagation(), чтобы клик по кнопке не уводил в урок.

4.3. Визуальная аккуратность
- Не раздувать карточки по умолчанию: только по явному действию пользователя.
- Сохранить текущий стиль GlassCard/градиенты.

5) Проверки, тестирование и “пруфы” (скриншоты)
Важно: после внедрения я сделаю проверку именно в интерфейсе (не “теория”), и в финальном отчёте приложу скриншоты.

5.1. Чек-лист ручного E2E (минимум)
A) /knowledge → вкладка “Вопросы”
- Нажать “Смотреть видеоответ”:
  - не открывается новая вкладка,
  - маршрут меняется на /library/...,
  - на странице урока видео стартует на нужном таймкоде.

B) /library/.../episode-100 (страница урока)
- Убедиться, что хлебные крошки ОДНИ (нет дубля в шапке + в контенте).
- Убедиться, что все пункты на русском (“База знаний → Выпуск №100”).
- В блоке “Вопросы этого выпуска” нажать Play:
  - видео переходит к таймкоду,
  - видео реально начинает играть (без повторного клика по Play в плеере).

C) Превью карточек выпусков (видеответов)
- Проверить раскрытие полного описания:
  - desktop: hover-card,
  - mobile/tablet: кнопка развернуть (и что она не уводит в урок).

D) Регрессия UI
- Проверить основные “выпадающие” элементы и поля на затронутых страницах:
  - Tabs на /knowledge,
  - поиск,
  - кнопки “К списку”, навигация prev/next, “Отметить как пройденный” на уроке,
  - sidebar toggle.

5.2. Скриншоты (что именно приложим)
- /knowledge “Вопросы” до клика (видна кнопка “Смотреть видеоответ”).
- После клика: страница /library/... с видимыми русскими хлебными крошками (одна линия).
- Момент автозапуска: видно, что плеер “играет” (по UI плеера/индикатору) и таймкод соответствует.
- Превью карточки: hover-card (desktop) и разворот (mobile).
- Консоль без ошибок на ключевом сценарии (если будут — приложим и исправим).

Технические детали реализации (чтобы без сюрпризов)
- Для Kinescope IFrame API используем официальную документацию (player.kinescope.io/latest/iframe.player.js).
- Не добавляем новых зависимостей (add-only подход): всё можно сделать через загрузку скрипта и типизацию “как any” локально.
- Не меняем доступы/безопасность, только UI/клиентскую навигацию/воспроизведение.
- Все клики, которые не должны уводить со страницы, обязательно с stopPropagation.

Ожидаемые затронутые файлы (минимально)
- src/components/admin/lesson-editor/blocks/VideoBlock.tsx
- src/pages/LibraryLesson.tsx
- src/pages/Knowledge.tsx
- src/components/layout/DashboardLayout.tsx
- src/components/layout/DashboardBreadcrumbs.tsx
- src/components/training/LessonCard.tsx

Критерии приёмки (DoD)
1) “Смотреть видеоответ” из /knowledge не открывает внешний сайт и не открывает новую вкладку.
2) При переходе из вопроса видео:
   - перематывается к таймкоду,
   - и запускается автоматически (без повторного нажатия Play в плеере).
3) Хлебные крошки не дублируются и полностью русские; нет “episode-100” в UI.
4) Полный текст краткого описания доступен удобно на desktop и mobile/tablet.
5) Финальный отчёт: реальные скриншоты ключевых сценариев + короткий diff-summary по файлам.
