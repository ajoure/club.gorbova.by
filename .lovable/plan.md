
Цель: добиться, чтобы на iPhone (iOS Safari) внутри lovable.dev редактора больше не происходило «На странице … повторно возникла проблема», за счёт того, что превью приложения гарантированно НЕ загружает React/админку/данные вообще (всегда уходит в ultra-lite заглушку). Сейчас заглушка появляется не всегда: по скринам видно, что иногда Safari падает на самой странице lovable.dev, а иногда — превью всё-таки успевает загрузить реальное приложение (лендинг/админка), что снова разгоняет память.

---

## 0) Переформулировка проблемы (фиксируем факт)
- Опубликованный сайт на iPhone работает.
- Падает именно связка **lovable.dev редактор + превью**.
- Мы уже заменили превью на «заглушку» (stub) для iOS Safari, но:
  - по вашим скринам заглушка то появляется, то нет;
  - иногда Safari пишет «повторно возникла проблема» именно на URL lovable.dev/projects/… (то есть падает весь редактор).

Вывод: текущий “isPreview” детектор в index.html **не всегда распознаёт, что мы в контексте lovable.dev редактора**, поэтому иногда заглушка не включается и приложение успевает начать грузиться/потреблять память.

Do I know what the issue is?
- Да: **недостаточно надёжное определение “preview/editor context”**. Сейчас мы полагаемся только на `inIframe` и query flags (`forceHideBadge/lovable/preview`). На мобильном lovable.dev (или в некоторых режимах) превью может открываться без iframe/без этих флагов — тогда stub не включается.

---

## 1) Что меняем (минимально и точечно, add-only)
Единственный файл: `index.html`

### 1.1. Усилить определение “мы внутри lovable.dev редактора”
Добавляем ещё один сигнал:
- `document.referrer` содержит `lovable.dev` (это ключевой маркер, когда превью открыто из редактора даже если нет iframe/флагов).

Новая логика:
- `isEditorContext = inIframe || hasPreviewFlag || referrerHasLovable`

Где:
- `referrerHasLovable = (document.referrer || '').includes('lovable.dev')`

Почему это безопасно:
- В обычном открытии опубликованного сайта/прямой ссылки referrer чаще всего пустой или не lovable.dev — значит stub не включится.
- Внутри lovable.dev referrer почти всегда будет `https://lovable.dev/...` (с учётом стандартной политики referrer, как минимум origin).

### 1.2. Запускать stub как можно раньше
Чтобы максимально уменьшить шанс “успеть начать грузить приложение”:
- перенести текущий guard-скрипт из `<body>` в `<head>` (сразу после `<meta charset>` / `<meta viewport>`, до любых потенциально тяжёлых вещей)
- это не меняет поведение десктопа, но на iOS даст более раннюю остановку.

### 1.3. Жёстко останавливать загрузку ресурсов перед подменой документа
Перед `document.open()`:
- вызвать `window.stop()` (в try/catch), чтобы прервать любые начавшиеся загрузки/парсинг
- затем `document.open/write/close` как сейчас
- затем `return;` (и/или `throw` как сейчас) — но сделаем аккуратно: `return;` после подмены документа, а `throw` оставим только как дополнительный стоп в случае, если выполнение продолжится.

### 1.4. Лёгкая диагностическая подпись внутри заглушки (необязательно, но помогает доказательству)
Добавить в stub маленький текст внизу (серым, 10–11px):
- `context: iframe=<true/false>, flag=<true/false>, ref=<true/false>`
Это нужно, чтобы по скриншоту можно было доказать, что детектор реально сработал “через referrer” (и почему раньше не срабатывал).

Важно: никакой внешней отладки/консоли на iPhone не требуется — доказательство будет на самом экране.

---

## 2) Проверки / критерии готовности (DoD)
### DoD-A (главный)
1) На iPhone: открыть `https://lovable.dev/projects/...` (ваш проект)
2) Переключиться на вкладку Preview
3) Должна стабильно появляться заглушка “Мобильный режим” без падения Safari, причём **каждый раз** (10 из 10 перезагрузок страницы).

### DoD-B (верификация, что это именно редакторный контекст)
- На заглушке виден диагностический хвост (например `ref=true`), подтверждающий, что stub включился из-за lovable.dev контекста.

### DoD-C (десктоп не сломан)
- На десктопе lovable.dev превью работает как раньше (не показывается заглушка).

---

## 3) Доказательства выполнения (как вы требуете)
1) Скриншот iPhone внутри lovable.dev (адресная строка видна), где показана заглушка + диагностическая строка контекста.
2) Скриншот iPhone после 2–3 обновлений страницы подряд, что снова заглушка и нет “повторно возникла проблема”.
3) Скриншот десктопного превью (что всё как раньше).
4) Diff-summary: изменён только `index.html` (и почему).

---

## 4) Почему это должно сработать
- Сейчас stub зависит от `iframe`/`query flags`. Если lovable.dev мобильный режим иногда открывает превью без iframe/флага — stub не включается.
- `document.referrer` — самый надёжный способ понять “меня открыли из lovable.dev”, даже если iframe/flags отсутствуют.
- Перенос в `<head>` + `window.stop()` снижает вероятность, что iOS успеет раздуть память до критического порога.

---

## 5) План внедрения (последовательность)
1) Прочитать текущий `index.html` и аккуратно перенести скрипт в `<head>` (без изменений остальной разметки).
2) Расширить вычисление `isPreview` → `isEditorContext` с учётом `document.referrer`.
3) Добавить `window.stop()` и ранний `return` после подмены документа.
4) Добавить диагностическую строку в stub (минимально, без новых стилей/зависимостей).
5) Проверка: iPhone lovable.dev (несколько перезагрузок), затем десктоп.

---

## 6) Риск/ограничение (фиксируем честно)
Если даже при полном отключении загрузки превью (stub 100% всегда) lovable.dev на iPhone всё равно продолжит падать — значит редактор lovable.dev сам по себе превышает лимиты iOS Safari и это не исправляется кодом проекта. Тогда единственный рабочий процесс на iPhone — Chat без Preview (или работа с десктопа). Но текущий шаг нужен, чтобы это доказать детерминированно.
