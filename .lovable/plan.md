
# –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –í—ã–ø–∏—Å–∫–æ–π bePaid

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—Ç–º–µ–Ω—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
**–ü—Ä–∏—á–∏–Ω–∞:** –í `PaymentsStatsPanel.tsx` —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ 5 –∫–∞—Ä—Ç–æ—á–µ–∫: –£—Å–ø–µ—à–Ω—ã–µ, –í–æ–∑–≤—Ä–∞—Ç—ã, –û—à–∏–±–∫–∏, –ö–æ–º–∏—Å—Å–∏—è, –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞. –ö–∞—Ä—Ç–æ—á–∫–∞ "–û—Ç–º–µ–Ω—ã" (cancelled) –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Ö–æ—Ç—è –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ—ë –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è.

### 2. –°–∏–º–≤–æ–ª —Ä—É–±–ª—è –≤–º–µ—Å—Ç–æ BYN
**–ü—Ä–∏—á–∏–Ω–∞:** –í `SyncWithStatementDialog.tsx` –≤ —Å—Ç—Ä–æ–∫–∞—Ö 464, 468, 472, 479, 483, 487, 494, 498, 502, 509, 513, 517, 522, 524 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏–º–≤–æ–ª `‚ÇΩ` –≤–º–µ—Å—Ç–æ `BYN`.

### 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ (–ö–†–ò–¢–ò–ß–ù–û!)
**–°–∏–º–ø—Ç–æ–º:** Edge Function –ª–æ–≥–∏—Ä—É–µ—Ç "Completed: 221 create, 461 update, 9 delete", –Ω–æ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –Ω–µ –º–µ–Ω—è—é—Ç—Å—è.

**–ü—Ä–∏—á–∏–Ω—ã:**
a) **–ö–æ–ª–æ–Ω–∫–∞ `card_holder` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** –≤ —Ç–∞–±–ª–∏—Ü–µ `payments_v2`. Edge Function –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å–∞—Ç—å –≤ –Ω–µ—ë, –≤—ã–∑—ã–≤–∞—è SQL-–æ—à–∏–±–∫—É.
b) **–ù–µ–≤–µ—Ä–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ enum —Å—Ç–∞—Ç—É—Å–∞** ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `cancelled` (–¥–≤–µ l), –Ω–æ enum `payment_status` —Å–æ–¥–µ—Ä–∂–∏—Ç `canceled` (–æ–¥–Ω–∞ l).
c) **–¢–∏—Ö–∏–µ –æ—à–∏–±–∫–∏** ‚Äî –∫–æ–¥ –≤ try/catch –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É. –°—á—ë—Ç—á–∏–∫ `stats.applied++` –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç, –±—ã–ª–∞ –ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–π.

---

## –†–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É "–û—Ç–º–µ–Ω—ã" –≤ PaymentsStatsPanel.tsx

**–§–∞–π–ª:** `src/components/admin/payments/PaymentsStatsPanel.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å 6-—é –∫–∞—Ä—Ç–æ—á–∫—É "–û—Ç–º–µ–Ω—ã" –º–µ–∂–¥—É "–û—à–∏–±–∫–∏" –∏ "–ö–æ–º–∏—Å—Å–∏—è".

```tsx
// –ü–æ—Å–ª–µ –∫–∞—Ä—Ç–æ—á–∫–∏ "–û—à–∏–±–∫–∏" (—Å—Ç—Ä–æ–∫–∞ ~184)
<StatCard
  title="–û—Ç–º–µ–Ω—ã"
  amount={stats.cancelled.amount}
  count={stats.cancelled.count}
  icon={<XCircle className="h-4 w-4 text-orange-400" />}
  colorClass="text-orange-400"
  accentGradient="from-orange-500 to-orange-400"
/>
```

---

### –†–µ—à–µ–Ω–∏–µ 2: –ó–∞–º–µ–Ω–∏—Ç—å ‚ÇΩ –Ω–∞ BYN –≤ SyncWithStatementDialog.tsx

**–§–∞–π–ª:** `src/components/admin/payments/SyncWithStatementDialog.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –≤—Ö–æ–∂–¥–µ–Ω–∏—è `‚ÇΩ` –Ω–∞ `BYN` –≤ —Ç–∞–±–ª–∏—Ü–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å—Ç—Ä–æ–∫–∏ 464-524).

```tsx
// –ë—ã–ª–æ:
<div className="text-xs text-muted-foreground">{formatAmount(stats.statement_stats.succeeded.amount)} ‚ÇΩ</div>

// –°—Ç–∞–Ω–µ—Ç:
<div className="text-xs text-muted-foreground">{formatAmount(stats.statement_stats.succeeded.amount)} BYN</div>
```

---

### –†–µ—à–µ–Ω–∏–µ 3: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É card_holder –≤ payments_v2

**–î–µ–π—Å—Ç–≤–∏–µ:** –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏.

```sql
ALTER TABLE public.payments_v2 
ADD COLUMN IF NOT EXISTS card_holder text;

COMMENT ON COLUMN public.payments_v2.card_holder IS 'Card holder name from bePaid statement';
```

---

### –†–µ—à–µ–Ω–∏–µ 4: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Å—Ç–∞—Ç—É—Å–∞ –≤ Edge Function

**–§–∞–π–ª:** `supabase/functions/sync-payments-with-statement/index.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `normalizeStatus` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `cancelled`, –Ω–æ enum –≤ –ë–î —Ç—Ä–µ–±—É–µ—Ç `canceled`.

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –í —Ñ—É–Ω–∫—Ü–∏–∏ `normalizeStatus` –∑–∞–º–µ–Ω–∏—Ç—å:
```typescript
// –ë—ã–ª–æ:
if (['cancelled', 'canceled', '–æ—Ç–º–µ–Ω–∞', 'void'].includes(s)) return 'cancelled';

// –°—Ç–∞–Ω–µ—Ç:
if (['cancelled', 'canceled', '–æ—Ç–º–µ–Ω–∞', 'void'].includes(s)) return 'canceled';
```

---

### –†–µ—à–µ–Ω–∏–µ 5: –î–æ–±–∞–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ (orders) –≤–º–µ—Å—Ç–æ –æ—Ç–º–µ–Ω—ã

**–§–∞–π–ª:** `supabase/functions/sync-payments-with-statement/index.ts`

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ–π—á–∞—Å –ø—Ä–∏ –∫–∞—Å–∫–∞–¥–µ —Å–¥–µ–ª–∫–∏ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `cancelled`, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∏—Ö **—É–¥–∞–ª—è—Ç—å**.

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –ó–∞–º–µ–Ω–∏—Ç—å `UPDATE` –Ω–∞ `DELETE` –¥–ª—è `orders_v2`:

```typescript
// –ë—ã–ª–æ:
await supabaseAdmin
  .from('orders_v2')
  .update({ status: 'cancelled', meta: {...} })
  .eq('id', pmt.order_id);

// –°—Ç–∞–Ω–µ—Ç:
await supabaseAdmin
  .from('orders_v2')
  .delete()
  .eq('id', pmt.order_id);
```

---

### –†–µ—à–µ–Ω–∏–µ 6: –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å –ø–æ–¥—Å—á—ë—Ç–æ–º –Ω–µ—É–¥–∞—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–§–∞–π–ª:** `supabase/functions/sync-payments-with-statement/index.ts`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ `stats.failed` –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.

```typescript
// –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å SyncStats –¥–æ–±–∞–≤–∏—Ç—å:
errors: number;

// –í –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
try {
  // ... –æ–ø–µ—Ä–∞—Ü–∏—è
  stats.applied++;
} catch (e: any) {
  console.error(`[sync-statement] Error applying change ${change.uid}:`, e);
  stats.errors = (stats.errors || 0) + 1;
  // –ù–ï —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º applied
}
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ payments_v2 (–∞–∫—Ç—É–∞–ª—å–Ω–∞—è)

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –°—Ç–∞—Ç—É—Å |
|---------|-----|--------|
| card_last4 | text | ‚úÖ –ï—Å—Ç—å |
| card_brand | text | ‚úÖ –ï—Å—Ç—å |
| **card_holder** | - | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |

### Enum payment_status (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π)

```
pending, processing, succeeded, failed, refunded, canceled
```

**–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:** `canceled` (–æ–¥–Ω–∞ L), –Ω–µ `cancelled` (–¥–≤–µ L).

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. ‚öôÔ∏è **–ú–∏–≥—Ä–∞—Ü–∏—è** ‚Äî –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `card_holder` –≤ `payments_v2`
2. ‚úèÔ∏è **Edge Function** ‚Äî –ò—Å–ø—Ä–∞–≤–∏—Ç—å `normalizeStatus`: `cancelled` ‚Üí `canceled`
3. ‚úèÔ∏è **Edge Function** ‚Äî –ó–∞–º–µ–Ω–∏—Ç—å `UPDATE` –Ω–∞ `DELETE` –¥–ª—è —Å–¥–µ–ª–æ–∫
4. ‚úèÔ∏è **Edge Function** ‚Äî –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
5. ‚úèÔ∏è **UI (PaymentsStatsPanel)** ‚Äî –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É "–û—Ç–º–µ–Ω—ã"
6. ‚úèÔ∏è **UI (SyncWithStatementDialog)** ‚Äî –ó–∞–º–µ–Ω–∏—Ç—å `‚ÇΩ` –Ω–∞ `BYN`
7. üöÄ **–î–µ–ø–ª–æ–π** Edge Function
8. üß™ **–¢–µ—Å—Ç** ‚Äî –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

---

## DoD (Definition of Done)

- [ ] –ö–∞—Ä—Ç–æ—á–∫–∞ "–û—Ç–º–µ–Ω—ã" –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø–∞–Ω–µ–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- [ ] –í–∞–ª—é—Ç–∞ –≤–µ–∑–¥–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ "BYN", –Ω–µ "‚ÇΩ"
- [ ] –ö–æ–ª–æ–Ω–∫–∞ `card_holder` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ `payments_v2`
- [ ] –°—Ç–∞—Ç—É—Å `canceled` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–æ–¥–Ω–∞ L)
- [ ] –°–¥–µ–ª–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è, –∞ –Ω–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞—Å–∫–∞–¥–µ
- [ ] –°—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- [ ] –ü–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω—è—é—Ç—Å—è –≤ –ë–î
