
# План: Сверка и обновление статусов предзаписей "Бухгалтерия как бизнес"

## Текущее состояние

| Статус | Кол-во |
|--------|--------|
| paid | 20 |
| new | 8 |
| converted | 1 |

## Выявленные расхождения

### Группа A: Статус "new", но уже оплачено (4 записи)
Эти пользователи уже оплатили, но предзапись не обновилась:

| Имя | Email | Нужное действие |
|-----|-------|-----------------|
| Юлия Лялина | volodik_84@mail.ru | → paid |
| Вероника Матук | nika.1900735@mail.ru | → paid |
| Ксения Шуманская | kshumanskaya@gmail.com | → paid |
| Екатерина Кузьменок | kate_9292@mail.ru | → paid |

### Группа B: Статус "new", не оплачено — курс начался (4 записи)
Эти пользователи не оплатили, курс уже идёт — отменяем:

| Имя | Email | Нужное действие |
|-----|-------|-----------------|
| Анастасия Жевнерова | nastassia_87@mail.ru | → cancelled |
| Мария Громыко | slmmls@mail.ru | → cancelled |
| Светлана Евгеньевна | metelska7@mail.ru | → cancelled (дубль 1) |
| Светлана Евгеньевна Ярош | metelska7@mail.ru | → cancelled (дубль 2) |

---

## Миграция (SQL)

```sql
-- ============================================
-- PATCH: Обновление статусов предзаписей buh_business
-- ============================================

-- Группа A: new → paid (уже оплатили)
UPDATE course_preregistrations
SET 
  status = 'paid',
  updated_at = NOW(),
  notes = COALESCE(notes, '') || E'\n[Auto] 2026-02-05: Статус обновлён на paid (найдена оплаченная сделка)'
WHERE id IN (
  '67a011f5-8b9d-4ee2-9f98-042cbc1f7444',  -- Юлия Лялина
  '70af01f6-1580-4647-98fd-f3e594ed5d54',  -- Вероника Матук
  '5763ee04-a99d-444d-bb6f-62b19808243c',  -- Ксения Шуманская
  'b333f6f7-819b-473d-a6b2-2e7713087a08'   -- Екатерина Кузьменок
);

-- Группа B: new → cancelled (не оплатили, курс начался)
UPDATE course_preregistrations
SET 
  status = 'cancelled',
  updated_at = NOW(),
  notes = COALESCE(notes, '') || E'\n[Auto] 2026-02-05: Отменено — курс начался, оплата не поступила'
WHERE id IN (
  'dd071858-618e-42c2-91ee-964855903978',  -- Анастасия Жевнерова
  '2c178be8-549d-46e4-a8c7-b13ad38855ad',  -- Мария Громыко
  'd69baeb7-2a1d-4afc-b3a5-acad3a83fcb3',  -- Светлана Евгеньевна (дубль 1)
  '33fc4dd3-5e0c-4184-988e-96ee7ac79648'   -- Светлана Евгеньевна Ярош (дубль 2)
);
```

---

## Ожидаемый результат после миграции

| Статус | Было | Станет |
|--------|------|--------|
| paid | 20 | 24 (+4) |
| new | 8 | 0 |
| converted | 1 | 1 |
| cancelled | 0 | 4 (+4) |

---

## DoD

1. Все предзаписи со статусом "new" обработаны
2. Оплаченные → статус "paid"
3. Неоплаченные → статус "cancelled"
4. В notes добавлена причина изменения
5. На странице /admin/payments/preorders отображаются корректные статусы
