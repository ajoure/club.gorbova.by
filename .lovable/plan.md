
Цели этого исправления (по вашим жалобам)
1) Новые тестовые модули должны появляться в «Базе знаний» (/knowledge) сразу после создания (без «магии» и ожиданий).
2) После обновления/перезагрузки вы не должны «вываливаться» из кабинета (и не должны попадать на лендинг вместо кабинета).
3) «Назад к приложению» из админки должен вести в кабинет (/dashboard), а не на публичный лендинг.
4) В общем меню переименовать «Админ‑панель» в «Панель управления».
5) Убрать бессмысленные поля “URL видео / HTML контент” из формы создания/редактирования урока в админке (контент делается в редакторе блоков).
6) «Назад» из редактора контента урока не должен вести на 404.
7) Генерация обложки должна реально работать (с кнопки AI) и выдавать URL.

Что уже найдено (по коду и логам)
A) 404 из редактора урока — это реальный баг маршрута.
- В приложении нет маршрута `/admin/training-lessons/:moduleId` (в App.tsx есть только `/admin/training-modules/:moduleId/lessons` и `/admin/training-lessons/:moduleId/edit/:lessonId`).
- Но в `AdminLessonBlockEditor.tsx` кнопка «Назад» ведёт на `/admin/training-lessons/${moduleId}` → гарантированный 404.
- Та же ошибка есть в мастере: `ContentCreationWizard.tsx` после создания урока делает `navigate(/admin/training-lessons/${createdModuleId})`.

B) «Назад к приложению» в админ‑сайдбаре ведёт на `/`.
- В `AdminSidebar.tsx` это жёстко задано `to="/"`.
- А `"/"` у вас управляется `DomainHomePage` и на основном домене/preview показывает ЛЕНДИНГ (Landing), а не кабинет.
- Поэтому создаётся ощущение «меня выбросило» даже если сессия жива.

C) Новые вкладки/разделы и модули могут “не появляться” из‑за кеша react-query и неправильной инвалидции.
- `usePageSections("knowledge")` кэшируется (staleTime 5 минут).
- В `ContentSectionSelector.tsx` инвалидируется `["page-sections-tabs"]`, но реальный ключ запроса: `["page-sections-tabs", pageKey]`. То есть создаёте вкладку — а табы /knowledge могут не обновиться.
- Модули на /knowledge берутся из `useSidebarModules()` (queryKey `["sidebar-modules", user?.id]`) и тоже не инвалидируются после создания модуля в мастере/в админке.

D) Форма урока с video_url/content всё ещё присутствует в “Уроки модуля”.
- `AdminTrainingLessons.tsx` до сих пор использует старый `LessonFormContent` с полями `content`, `video_url`, `audio_url`, `duration_minutes`, `content_type`.
- То есть вы правы: “я сказал убрать — не убрано”.

E) AI-обложка не работает, потому что функция не доступна по HTTP (404).
- Вызов `/generate-cover` возвращает 404, логов функции нет → фактически функция не поднята/не развернулась или не доступна по имени.
- Даже если UI-кнопка есть, сейчас она будет падать.

План работ (что именно сделаем в следующем запросе в режиме редактирования)

1) Починить все неправильные маршруты “назад”, чтобы не было 404
Файлы:
- `src/pages/admin/AdminLessonBlockEditor.tsx`
- `src/components/admin/trainings/ContentCreationWizard.tsx`
Что делаем:
- Заменяем все переходы вида:
  - `/admin/training-lessons/${moduleId}`
  - на корректный список уроков модуля:
  - `/admin/training-modules/${moduleId}/lessons`
- Проверяем также карточки/кнопки “Уроки/Назад” по админскому разделу тренингов, чтобы нигде больше не было устаревшего пути.
Результат:
- “Назад” из редактора контента всегда возвращает на страницу уроков модуля без 404.

2) Сделать «Назад к приложению» реально возвращающим в кабинет, а не на лендинг
Файлы:
- `src/components/layout/AdminSidebar.tsx`
Опция (рекомендуемая):
- “Назад к приложению” ведёт на `/dashboard` (кабинет).
Дополнительно (чтобы было идеально):
- Запоминать “последний не‑админский маршрут” в localStorage (например `last_app_route`) и возвращать туда; если нет — fallback `/dashboard`.
Почему это важно:
- Сейчас `"/"` — это лендинг (по DomainRouter), поэтому “назад” уводит на публичный сайт и это воспринимается как logout.

3) Исправить ощущение “меня выбрасывает после обновления”
Файлы:
- `src/components/layout/DomainRouter.tsx` (или логика в `DomainHomePage`)
- (возможны небольшие правки в `ProtectedRoute` или логике после логина)
Что делаем:
- Для главного домена/preview:
  - если пользователь авторизован → `"/"` должен перекидывать в `/dashboard` (кабинет),
  - если не авторизован → показываем Landing как сейчас.
Почему это решит проблему:
- Даже при живой сессии сейчас перезагрузка `"/"` даёт лендинг, и вы вынуждены “вновь входить в кабинет”. Мы уберём этот “ложный logout”.
Параллельно:
- Добавим диагностические логи/тосты (в дев-режиме) только на случаи реального SIGNED_OUT события, чтобы отличать “попал на лендинг” от “сессия слетела”.

4) Переименовать “Админ‑панель” в меню пользователя в “Панель управления”
Файлы:
- `src/components/layout/AppSidebar.tsx` (текст и tooltip)
- `src/pages/Dashboard.tsx` (ссылка “Перейти в админ-панель”)
- `src/pages/Help.tsx` (карточка/раздел справки)
Что делаем:
- Меняем тексты на “Панель управления” (везде единообразно).
Результат:
- В UI больше не будет “Админ‑панель”, только “Панель управления”.

5) Убрать поля URL видео / HTML контент из админской формы урока (оставить только метаданные)
Файлы:
- `src/pages/admin/AdminTrainingLessons.tsx`
- (возможно) `src/hooks/useTrainingLessons.tsx` и тип `TrainingLessonFormData` (если типы строго требуют эти поля)
Что делаем:
- Заменяем текущий `LessonFormContent` на упрощённый компонент (аналогичный `LessonFormFieldsSimple`):
  - название, slug, краткое описание, активность (и при необходимости sort_order).
- Убираем UI для `content_type`, `video_url`, `audio_url`, `content`.
- В подсказке в диалоге пишем явно: “Видео/текст добавляйте в редакторе блоков в кнопке «Контент»”.
Важно:
- Колонки в базе можно оставить (не ломаем историю), просто перестаём их использовать.
Результат:
- Никакого дублирования: контент только через редактор блоков.

6) Сделать так, чтобы новые модули и вкладки сразу появлялись в /knowledge
Файлы:
- `src/components/admin/trainings/ContentSectionSelector.tsx`
- `src/components/admin/trainings/ContentCreationWizard.tsx`
- `src/hooks/useSidebarModules.ts`
- `src/hooks/usePageSections.ts` (если нужно централизовать invalidate)
Что делаем:
- Исправляем инвалидцию query key:
  - вместо `invalidateQueries(["page-sections-tabs"])` → инвалидируем `["page-sections-tabs", parent.page_key]` и `["page-sections-tree", parent.page_key]` (или корректный pageKey).
- После создания/удаления вкладки и после создания модуля:
  - инвалидируем `["sidebar-modules", userId]` (и общий `["sidebar-modules"]` если где-то используется).
- В мастере и/или в админке после “Готово” делаем принудительный refresh этих кэшей.
Результат:
- Создали вкладку/модуль → они появляются в /knowledge сразу, без ожидания 5 минут.

7) Починить генерацию AI-обложки (сейчас функция фактически недоступна)
Проблема:
- Вызов `/generate-cover` сейчас 404 и логов нет → функция не развернута или не доступна по имени.
Файлы:
- `supabase/functions/generate-cover/index.ts`
- `supabase/config.toml`
Что делаем:
- В режиме редактирования:
  1) Переразвернём функцию принудительно (deploy) и проверим вызовом.
  2) Если 404 останется — проверим конфигурацию имени/папки и исправим так, чтобы endpoint существовал.
  3) Добавим явный возврат ошибок в UI (toast) с понятным текстом.
- В UI (`ModuleFormFields.tsx`) улучшим UX:
  - отображение прогресса,
  - кнопка “Перегенерировать”,
  - если модуль ещё не создан — генерируем во временный путь, а после сохранения модуля (в мастере) перезаписываем обложку уже с moduleId.
Результат:
- Нажали “AI” → получили реальную обложку (URL), которая отображается и сохраняется.

8) Проверочный прогон (симуляция end-to-end, чтобы больше не было “ничего не работает”)
Сценарий теста (в админке):
1) Создать вкладку в /knowledge (только созданные вкладки).
2) Создать модуль через мастер в эту вкладку.
3) Сгенерировать AI-обложку (проверить, что URL появился и картинка грузится).
4) Создать урок (только название/описание).
5) Открыть “Контент” и добавить блок Video (кинескоп/любая ссылка) → убедиться, что блок сохраняется.
6) Нажать “Просмотр” в редакторе контента → убедиться, что блоки отображаются.
7) Нажать “Назад” → убедиться, что нет 404 и вы возвращаетесь к урокам модуля.
8) Открыть /knowledge → убедиться, что созданный модуль появился в нужной вкладке.
9) Перезагрузить страницу (Ctrl+R) в кабинете/админке → убедиться, что вы остались залогинены и попали в кабинет, а не на лендинг.

Критические уточнения (чтобы сделать ровно “как вы хотите”, без угадываний)
1) Когда вы говорите “не выбрасывало после обновления”, правильное целевое поведение такое?
- Перезагружаю /dashboard → остаюсь в кабинете без логина.
- Перезагружаю / → если я залогинен, меня сразу переносит в /dashboard.
2) “База знаний”: вы хотите, чтобы все новые “knowledge-*” модули открывались и жили на пути `/library/:moduleSlug` (как сейчас), но в хлебных крошках и входной точке всегда показывалось /knowledge — правильно? (Сейчас так и задумано: /knowledge — каталог/вкладки, /library — страница конкретного модуля/урока.)

Объем изменений (чтобы вы понимали масштаб)
- Это не “косметика”, а серия точечных фиксов маршрутов, кэш-инвалидации и поведения главной страницы для залогиненного пользователя + восстановление работоспособности AI-функции.

После выполнения вы получите
- Никаких 404 “назад”.
- “Назад к приложению” ведет в кабинет.
- Модули/вкладки появляются в /knowledge сразу.
- В уроках исчезнут поля, которые не используются редактором контента.
- AI-обложка реально генерируется и ставится.
